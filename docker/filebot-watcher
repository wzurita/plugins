#!/bin/sh -u

inotifywait -m "$1" -e create -e moved_to -e modify --exclude '/[.@]' --format '%w%f' | stdbuf -oL uniq | while read -r FILE; do
	# file may yield inode/x-empty for new files
	sleep 2

	# abort if the file has been modified while we were asleep
	if [ `find "$FILE" -type f -newermt '2 seconds ago' -print -quit` ]; then
		echo "Modified: $FILE"
		continue
	fi

	# e.g. video.mp4: video/mp4
	if file --mime-type "$FILE" | egrep "directory|video|audio|empty|octet-stream"; then
		/usr/share/filebot/filebot.sh -script fn:amc --action duplicate --conflict auto -non-strict --log-file amc.log --def movieFormat="movies/{ny}/{fn}" seriesFormat="tv/{n}/{\"\${s.pad(2)}\"}/{n}.{s00e00}.{t}" excludeList=".excludes" unsorted=y music=n artwork=n /watch --output /output
	fi
done
